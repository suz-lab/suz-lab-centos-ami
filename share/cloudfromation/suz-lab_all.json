{
    "AWSTemplateFormatVersion": "2010-09-09", 
    "Description": "SUZ-LAB Formation ALL", 
    "Mappings": {
        "AvailabilityZoneMap": {
            "ap-northeast-1": {
                "AZA": "ap-northeast-1a", 
                "AZB": "ap-northeast-1b", 
                "AZC": "ap-northeast-1c"
            }
        }
    }, 
    "Parameters": {
	"VpcCidrIp": {
            "AllowedPattern": "^(\\d|[01]?\\d\\d|2[0-4]\\d|25[0-5])\\.(\\d|[01]?\\d\\d|2[0-4]\\d|25[0-5])", 
            "Default": "10.0", 
            "Description": "VPC CIDR IP (X.X.0.0/16)", 
            "Type": "String"
        },
	"SourceName": {
            "Default": "suzlab", 
            "Description": "Source Name", 
            "Type": "String"
        },
	"SourceCidrIp": {
            "Default": "0.0.0.0/0", 
            "Description": "Source CIDR IP", 
            "Type": "String"
        },
	"KeyName": {
            "Default": "", 
            "Description": "Key Name", 
            "Type": "String"
        }, 
        "StepImageId": {
	    "AllowedPattern": "^ami-[0-9a-z]{8}",
            "Default": "ami-3417ae35",
            "Description": "Step Image ID", 
            "Type": "String"
        }, 
        "StepInstanceType": {
            "Default": "t1.micro", 
            "Description": "Step Instance Type", 
            "Type": "String"
        }, 
        "StepName": {
            "Default": "step", 
            "Description": "Step Name", 
            "Type": "String"
        },
	"OnDemandNatImageId": {
	    "AllowedPattern": "^ami-[0-9a-z]{8}",
            "Default": "ami-14d86d15",
            "Description": "OnDemand NAT Image ID", 
            "Type": "String"
        }, 
        "OnDemandNatInstanceType": {
            "Default": "t1.micro", 
            "Description": "OnDemand NAT Instance Type", 
            "Type": "String"
        }, 
        "OnDemandNatName": {
            "Default": "ondemand-nat", 
            "Description": "OnDemand NAT Name", 
            "Type": "String"
        }
    }, 
    "Resources": {
        "CloudFormationStackVpcBasic" : {
	    "Type": "AWS::CloudFormation::Stack",
	    "Properties": {
	        "TemplateURL": "https://s3-ap-northeast-1.amazonaws.com/template.suz-lab.com/template/suz-lab_vpc-basic-0.0.2.json",
	        "Parameters" : {
		    "VpcCidrIp": { "Ref" : "VpcCidrIp" }
		}
	    } 
	},
	"CloudFormationStackOperationalFirewall" : {
  	    "Type": "AWS::CloudFormation::Stack",
	    "Properties": {
	        "TemplateURL" : "https://s3-ap-northeast-1.amazonaws.com/template.suz-lab.com/template/suz-lab_operational-firewall-0.0.2.json",
	        "Parameters" : {
	            "VpcCidrIp": { "Fn::GetAtt" : [ "CloudFormationStackVpcBasic", "Outputs.VpcCidrIpBasic" ] },
		    "VpcId": { "Fn::GetAtt" : [ "CloudFormationStackVpcBasic", "Outputs.VpcIdBasic" ] },
		    "SourceName": { "Ref" : "SourceName" },
		    "SourceCidrIp": { "Ref" : "SourceCidrIp" }
	        }
   	    }
        },
	"CloudFormationStackStep" : {
  	    "Type": "AWS::CloudFormation::Stack",
	    "Properties": {
	        "TemplateURL" : "https://s3-ap-northeast-1.amazonaws.com/template.suz-lab.com/template/suz-lab_step-0.0.1.json",
	        "Parameters" : {
	            "KeyName": { "Ref": "KeyName" },
                    "ImageId": { "Ref": "StepImageId" }, 
	            "InstanceType": { "Ref": "StepInstanceType" },
	            "Name": { "Ref": "StepName" },
	            "SecurityGroupIds": { "Fn::Join": [ ",", [ 
		        { "Fn::GetAtt" : [ "CloudFormationStackOperationalFirewall", "Outputs.SecurityGroupIdStepSource" ] },
			{ "Fn::GetAtt" : [ "CloudFormationStackOperationalFirewall", "Outputs.SecurityGroupIdStep" ] },
                        { "Fn::GetAtt" : [ "CloudFormationStackOperationalFirewall", "Outputs.SecurityGroupIdEc2" ] }
		    ] ] },
	            "SubnetId": { "Fn::GetAtt" : [ "CloudFormationStackVpcBasic", "Outputs.SubnetIdPublicVarA00" ] },
	            "VpcId": { "Fn::GetAtt" : [ "CloudFormationStackVpcBasic", "Outputs.VpcIdBasic" ] }
	        }
   	    }
        },
	"CloudFormationStackOnDemandNat" : {
  	    "Type": "AWS::CloudFormation::Stack",
	    "Properties": {
	        "TemplateURL" : "https://s3-ap-northeast-1.amazonaws.com/template.suz-lab.com/template/suz-lab_ondemand-nat-0.0.2.json",
	        "Parameters" : {
	            "KeyName": { "Ref": "KeyName" },
                    "ImageId": { "Ref": "OnDemandNatImageId" }, 
	            "InstanceType": { "Ref": "OnDemandNatInstanceType" },
	            "Name": { "Ref": "OnDemandNatName" },
	            "RouteTableId": { "Fn::GetAtt" : [ "CloudFormationStackVpcBasic", "Outputs.RouteTableIdProtected" ] },
	            "SecurityGroupIds": { "Fn::Join": [ ",", [ 
		        { "Fn::GetAtt" : [ "CloudFormationStackOperationalFirewall", "Outputs.SecurityGroupIdNat" ] },
                        { "Fn::GetAtt" : [ "CloudFormationStackOperationalFirewall", "Outputs.SecurityGroupIdEc2" ] }
		    ] ] },
	            "SubnetId": { "Fn::GetAtt" : [ "CloudFormationStackVpcBasic", "Outputs.SubnetIdPublicVarA00" ] },
	            "VpcId": { "Fn::GetAtt" : [ "CloudFormationStackVpcBasic", "Outputs.VpcIdBasic" ] }
	        }
   	    }
        }
    },
    "Outputs": {
        "GuidelineVpcBasic": {
            "Value": { "Fn::GetAtt" : [ "CloudFormationStackVpcBasic", "Outputs.Guideline" ] }
        },
	"GuidelineOperationalFirewall": {
            "Value": { "Fn::GetAtt" : [ "CloudFormationStackOperationalFirewall", "Outputs.Guideline" ] }
        },
	"GuidelineOperationalStep": {
            "Value": { "Fn::GetAtt" : [ "CloudFormationStackStep", "Outputs.Guideline" ] }
        },
	"GuidelineOperationalOnDemandNat": {
            "Value": { "Fn::GetAtt" : [ "CloudFormationStackOnDemandNat", "Outputs.Guideline" ] }
        }
    } 
}

